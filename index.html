<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vínculo Financeiro - Gestão Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-dark: #050505;
            --card-dark: #121212;
            --border-dark: #1f1f1f;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f4f4f5;
        }

        .bubble-card {
            background: linear-gradient(145deg, #161616, #0d0d0d);
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 24px;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease;
        }

        .tab-active {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
        }

        input, select {
            background-color: #1a1a1a !important;
            border: 1px solid #2d2d2d !important;
            color: white !important;
        }

        input:focus, select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="pb-20">

    <header class="p-8 border-b border-zinc-900 bg-black/40 backdrop-blur-xl sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight text-white flex items-center gap-2">
                    <span class="p-2 bg-blue-600 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    </span>
                    Vínculo Financeiro
                </h1>
                <p id="current-date-display" class="text-zinc-500 text-xs font-bold uppercase tracking-widest mt-1"></p>
            </div>
            <button onclick="resetData()" class="text-[10px] text-zinc-600 hover:text-zinc-400 uppercase font-bold border border-zinc-800 px-3 py-1 rounded-full">Limpar Tudo</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 mt-6">
        
        <div class="flex gap-8 mb-8 border-b border-zinc-900 px-2">
            <button onclick="switchTab('monthly')" id="tab-monthly" class="pb-4 font-bold tab-active">Visão Mensal</button>
            <button onclick="switchTab('yearly')" id="tab-yearly" class="pb-4 font-bold text-zinc-600 hover:text-zinc-400">Análise Anual</button>
        </div>

        <!-- Visão Mensal -->
        <section id="section-monthly" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bubble-card p-6 border-l-4 border-emerald-500/50">
                    <span class="text-zinc-500 text-xs font-bold uppercase block mb-2">Entradas</span>
                    <p id="display-income" class="text-3xl font-bold text-white">R$ 0,00</p>
                </div>
                <div class="bubble-card p-6 border-l-4 border-rose-500/50">
                    <span class="text-zinc-500 text-xs font-bold uppercase block mb-2">Saídas</span>
                    <p id="display-expenses" class="text-3xl font-bold text-white">R$ 0,00</p>
                </div>
                <div class="bubble-card p-6 border-l-4 border-blue-500/50">
                    <span class="text-zinc-500 text-xs font-bold uppercase block mb-2">Líquido</span>
                    <p id="display-balance" class="text-3xl font-bold text-white">R$ 0,00</p>
                </div>
            </div>

            <!-- Formulário -->
            <div class="bubble-card p-8 bg-zinc-900/50" id="form-container">
                <h3 id="form-title" class="text-lg font-bold mb-6 flex items-center gap-2 italic">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                    Novo Lançamento
                </h3>
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div class="space-y-2">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Descrição</label>
                        <input type="text" id="desc-input" placeholder="Ex: Salário" class="w-full p-3.5 rounded-2xl outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Valor</label>
                        <input type="number" id="value-input" placeholder="0.00" step="0.01" class="w-full p-3.5 rounded-2xl outline-none">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Classificação</label>
                        <select id="type-input" class="w-full p-3.5 rounded-2xl outline-none appearance-none">
                            <option value="Renda">Renda</option>
                            <option value="Despesa Fixa">Despesa Fixa</option>
                            <option value="Despesa Variavel">Despesa Variável</option>
                            <option value="Investimento">Investimento</option>
                            <option value="Poupança">Poupança</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Mês de Início</label>
                        <select id="start-month-input" class="w-full p-3.5 rounded-2xl outline-none appearance-none"></select>
                    </div>
                    
                    <!-- Campos de Recorrência -->
                    <div class="space-y-2">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Recorrência</label>
                        <select id="recurrence-input" onchange="toggleParcelInput()" class="w-full p-3.5 rounded-2xl outline-none appearance-none">
                            <option value="unico">Apenas o mês de início</option>
                            <option value="fixo">Mensal (Fixo)</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>

                    <div id="parcel-container" class="space-y-2 hidden">
                        <label class="text-xs text-zinc-500 ml-2 font-bold uppercase">Qtd. Parcelas</label>
                        <input type="number" id="installments-input" placeholder="Ex: 12" min="2" class="w-full p-3.5 rounded-2xl outline-none">
                    </div>

                    <div class="flex items-end gap-2 lg:col-span-3">
                        <button id="btn-submit" onclick="addEntry()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition-all uppercase text-xs tracking-widest">
                            Salvar Lançamento
                        </button>
                        <button id="btn-cancel" onclick="cancelEdit()" class="hidden bg-zinc-800 hover:bg-zinc-700 text-white font-black py-4 px-6 rounded-2xl transition-all uppercase text-xs tracking-widest">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="bubble-card p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="text-lg font-bold">Histórico do Mês</h3>
                    <select onchange="changeFilterMonth(this.value)" id="month-filter" class="text-xs p-2 rounded-lg bg-zinc-800 font-bold outline-none border-none"></select>
                </div>
                <div class="overflow-x-auto custom-scroll">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-zinc-500 text-[10px] uppercase border-b border-zinc-800 font-black">
                                <th class="pb-4 pl-2">Descrição</th>
                                <th class="pb-4">Categoria</th>
                                <th class="pb-4 text-right">Valor</th>
                                <th class="pb-4 text-right pr-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-history" class="text-zinc-300 text-sm"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="py-20 text-center hidden">
                    <p class="text-zinc-600 font-bold uppercase text-[10px] tracking-widest">Nenhum lançamento encontrado neste mês</p>
                </div>
            </div>
        </section>

        <!-- Visão Anual -->
        <section id="section-yearly" class="hidden space-y-8">
            <div class="bubble-card p-8">
                <h3 class="text-lg font-bold mb-8 text-center">Fluxo de Caixa Anual</h3>
                <div class="h-80">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bubble-card p-6">
                    <h4 class="text-sm font-bold uppercase text-zinc-500 mb-4 tracking-widest">Resumo do Ano</h4>
                    <div id="yearly-category-summary" class="space-y-4"></div>
                </div>
                <div class="bubble-card p-6">
                    <h4 class="text-sm font-bold uppercase text-zinc-500 mb-4 tracking-widest">Resumo Mensal (Líquido)</h4>
                    <div id="yearly-summary-list" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2"></div>
                </div>
            </div>
        </section>

    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-zinc-900 border border-zinc-800 p-4 rounded-2xl shadow-2xl opacity-0 transition-all z-[100] flex items-center gap-4 pointer-events-none">
        <div id="toast-icon" class="w-1.5 h-8 bg-blue-500 rounded-full"></div>
        <p id="toast-text" class="font-bold text-sm"></p>
    </div>

    <script>
        const categories = ["Renda", "Despesa Fixa", "Despesa Variavel", "Investimento", "Poupança"];
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        let selectedMonth = new Date().getMonth();
        let selectedYear = 2026;
        let chartInstance = null;
        let transactions = [];

        function initData() {
            const stored = localStorage.getItem('vinculo_financeiro_v2');
            if (stored) {
                transactions = JSON.parse(stored);
            } else {
                transactions = [];
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initData();
            initFilters();
            updateDisplayDate();
            renderMonthly();
        });

        function initFilters() {
            // Filtro da Tabela
            const filter = document.getElementById('month-filter');
            filter.innerHTML = "";
            months.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = m;
                if(i === selectedMonth) opt.selected = true;
                filter.appendChild(opt);
            });

            // Filtro de Início no Formulário
            const startMonth = document.getElementById('start-month-input');
            startMonth.innerHTML = "";
            months.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = m;
                // Por padrão sugere o mês que está sendo visualizado
                if(i === selectedMonth) opt.selected = true;
                startMonth.appendChild(opt);
            });
        }

        function toggleParcelInput() {
            const recurrence = document.getElementById('recurrence-input').value;
            const container = document.getElementById('parcel-container');
            if (recurrence === 'parcelado') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function updateDisplayDate() {
            document.getElementById('current-date-display').innerText = `${months[selectedMonth]} ${selectedYear}`;
        }

        function changeFilterMonth(m) {
            selectedMonth = parseInt(m);
            updateDisplayDate();
            renderMonthly();
        }

        function addEntry() {
            const desc = document.getElementById('desc-input').value;
            const val = parseFloat(document.getElementById('value-input').value);
            const type = document.getElementById('type-input').value;
            const startMonth = parseInt(document.getElementById('start-month-input').value);
            const recurrence = document.getElementById('recurrence-input').value;
            const installments = parseInt(document.getElementById('installments-input').value) || 1;
            const editId = document.getElementById('edit-id').value;

            if (!desc || isNaN(val)) return showToast("Preencha descrição e valor!", "error");

            if (editId) {
                const index = transactions.findIndex(t => t.id === editId);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], description: desc, value: val, type: type };
                }
                cancelEdit();
                showToast("Lançamento atualizado!");
            } else {
                const groupId = Math.random().toString(36).substr(2, 9);
                
                if (recurrence === 'unico') {
                    transactions.push({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        description: desc, 
                        value: val, 
                        type: type, 
                        month: startMonth, 
                        year: selectedYear, 
                        recurrence: 'unico' 
                    });
                } else if (recurrence === 'fixo') {
                    // Começa a partir do mês de início selecionado até o fim do ano
                    for (let m = startMonth; m < 12; m++) {
                        transactions.push({ 
                            id: Math.random().toString(36).substr(2, 9), 
                            groupId, 
                            description: desc, 
                            value: val, 
                            type: type, 
                            month: m, 
                            year: selectedYear, 
                            recurrence: 'fixo' 
                        });
                    }
                } else if (recurrence === 'parcelado') {
                    for (let i = 0; i < installments; i++) {
                        let m = startMonth + i;
                        let y = selectedYear;
                        if (m > 11) { m = m % 12; y++; } 
                        if (y > selectedYear) break; 

                        transactions.push({ 
                            id: Math.random().toString(36).substr(2, 9), 
                            groupId, 
                            description: `${desc} (${i + 1}/${installments})`, 
                            value: val, 
                            type: type, 
                            month: m, 
                            year: y, 
                            recurrence: 'parcelado' 
                        });
                    }
                }
                showToast("Lançamento(s) adicionado(s)!");
            }

            save();
            clearInputs();
            renderMonthly();
        }

        function editTransaction(id) {
            const t = transactions.find(item => item.id === id);
            if (!t) return;

            document.getElementById('edit-id').value = t.id;
            document.getElementById('desc-input').value = t.description;
            document.getElementById('value-input').value = t.value;
            document.getElementById('type-input').value = t.type;
            
            // Esconde campos que não fazem sentido na edição individual simples
            document.getElementById('recurrence-input').parentElement.classList.add('hidden');
            document.getElementById('start-month-input').parentElement.classList.add('hidden');
            
            document.getElementById('form-title').innerText = "Editando Item";
            document.getElementById('btn-submit').innerText = "Atualizar Item";
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('edit-id').value = "";
            document.getElementById('form-title').innerText = "Novo Lançamento";
            document.getElementById('btn-submit').innerText = "Salvar Lançamento";
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('recurrence-input').parentElement.classList.remove('hidden');
            document.getElementById('start-month-input').parentElement.classList.remove('hidden');
            clearInputs();
        }

        function deleteTransaction(id) {
            const t = transactions.find(item => item.id === id);
            if (t && t.groupId) {
                if (confirm("Este item faz parte de um grupo. Deseja excluir TODOS os lançamentos deste grupo?")) {
                    transactions = transactions.filter(item => item.groupId !== t.groupId);
                } else {
                    transactions = transactions.filter(item => item.id !== id);
                }
            } else {
                transactions = transactions.filter(t => t.id !== id);
            }
            save();
            renderMonthly();
            showToast("Removido", "error");
        }

        function renderMonthly() {
            const data = transactions.filter(t => t.month === selectedMonth && t.year === selectedYear);
            let inc = 0, exp = 0;
            const tbody = document.getElementById('transaction-history');
            const emptyState = document.getElementById('empty-state');
            tbody.innerHTML = "";

            if (data.length === 0) {
                emptyState.classList.remove('hidden');
            } else {
                emptyState.classList.add('hidden');
            }

            data.sort((a, b) => b.value - a.value);

            data.forEach(t => {
                const isRenda = t.type === 'Renda';
                if (isRenda) inc += t.value; else exp += t.value;

                const tr = document.createElement('tr');
                tr.className = "border-b border-zinc-900/50 hover:bg-zinc-800/20 group";
                
                let badgeStyle = "bg-zinc-800 text-zinc-500";
                if(t.type === 'Renda') badgeStyle = "bg-emerald-500/10 text-emerald-500";
                if(t.type === 'Investimento') badgeStyle = "bg-blue-500/10 text-blue-500";
                if(t.type === 'Poupança') badgeStyle = "bg-purple-500/10 text-purple-500";
                if(t.type === 'Despesa Fixa') badgeStyle = "bg-zinc-700/50 text-zinc-300";

                tr.innerHTML = `
                    <td class="py-4 pl-2 font-bold text-zinc-100">
                        ${t.description}
                        ${t.recurrence === 'fixo' ? '<span class="ml-2 text-[8px] text-zinc-600 border border-zinc-800 px-1 rounded">FIXO</span>' : ''}
                    </td>
                    <td class="py-4"><span class="px-2 py-0.5 rounded text-[9px] font-black uppercase ${badgeStyle}">${t.type}</span></td>
                    <td class="py-4 text-right font-mono font-bold ${isRenda ? 'text-emerald-400' : 'text-rose-400'}">R$ ${t.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="py-4 text-right pr-2 space-x-3 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editTransaction('${t.id}')" class="text-blue-500 hover:text-blue-300 text-xs font-bold uppercase">Editar</button>
                        <button onclick="deleteTransaction('${t.id}')" class="text-zinc-600 hover:text-rose-500 text-xs font-bold uppercase">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('display-income').innerText = `R$ ${inc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('display-expenses').innerText = `R$ ${exp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            const bal = inc - exp;
            document.getElementById('display-balance').innerText = `R$ ${bal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('display-balance').className = `text-3xl font-bold ${bal >= 0 ? 'text-white' : 'text-orange-500'}`;
        }

        function switchTab(tab) {
            document.getElementById('section-monthly').classList.toggle('hidden', tab !== 'monthly');
            document.getElementById('section-yearly').classList.toggle('hidden', tab !== 'yearly');
            document.getElementById('tab-monthly').classList.toggle('tab-active', tab === 'monthly');
            document.getElementById('tab-yearly').classList.toggle('tab-active', tab === 'yearly');
            if(tab === 'yearly') renderYearly();
        }

        function renderYearly() {
            const annualData = months.map((_, i) => {
                const monthItems = transactions.filter(t => t.month === i && t.year === selectedYear);
                const inc = monthItems.filter(t => t.type === 'Renda').reduce((s, t) => s + t.value, 0);
                const exp = monthItems.filter(t => t.type !== 'Renda').reduce((s, t) => s + t.value, 0);
                return { inc, exp, bal: inc - exp };
            });

            const catTotals = {};
            categories.forEach(c => catTotals[c] = 0);
            transactions.filter(t => t.year === selectedYear).forEach(t => {
                catTotals[t.type] += t.value;
            });

            const catContainer = document.getElementById('yearly-category-summary');
            catContainer.innerHTML = "";
            categories.forEach(c => {
                const totalRenda = catTotals['Renda'] || 1;
                const perc = (catTotals[c] / totalRenda * 100).toFixed(1);
                catContainer.innerHTML += `
                    <div class="space-y-1">
                        <div class="flex justify-between text-xs font-bold">
                            <span class="text-zinc-400">${c}</span>
                            <span class="text-white">R$ ${catTotals[c].toLocaleString('pt-BR')}</span>
                        </div>
                        <div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                            <div class="h-full ${c === 'Renda' ? 'bg-emerald-500' : 'bg-blue-500'}" style="width: ${Math.min(perc, 100)}%"></div>
                        </div>
                    </div>
                `;
            });

            const summaryList = document.getElementById('yearly-summary-list');
            summaryList.innerHTML = "";
            months.forEach((m, i) => {
                const b = annualData[i].bal;
                summaryList.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-zinc-900/30 rounded-xl border border-zinc-800/50">
                        <span class="font-bold text-xs">${m}</span>
                        <span class="font-mono text-xs ${b >= 0 ? 'text-emerald-500' : 'text-rose-500'}">R$ ${b.toLocaleString('pt-BR')}</span>
                    </div>
                `;
            });

            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => m.substring(0, 3)),
                    datasets: [
                        { label: 'Entradas', data: annualData.map(d => d.inc), backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Saídas', data: annualData.map(d => d.exp), backgroundColor: '#f43f5e', borderRadius: 4 }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { grid: { color: '#1a1a1a' }, ticks: { color: '#555', font: { size: 10 } } }, 
                        x: { grid: { display: false }, ticks: { color: '#555', font: { size: 10 } } } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function save() { localStorage.setItem('vinculo_financeiro_v2', JSON.stringify(transactions)); }
        function clearInputs() { 
            document.getElementById('desc-input').value = ""; 
            document.getElementById('value-input').value = ""; 
            document.getElementById('installments-input').value = "";
            document.getElementById('recurrence-input').value = "unico";
            // Reseta para o mês atual selecionado
            document.getElementById('start-month-input').value = selectedMonth;
            toggleParcelInput();
        }
        function resetData() { 
            if(confirm("Deseja realmente apagar todos os lançamentos?")) {
                localStorage.removeItem('vinculo_financeiro_v2'); 
                location.reload(); 
            }
        }

        function showToast(msg, type = "success") {
            const t = document.getElementById('toast');
            document.getElementById('toast-text').innerText = msg;
            document.getElementById('toast-icon').className = `w-1.5 h-8 rounded-full ${type === 'error' ? 'bg-rose-500' : 'bg-blue-500'}`;
            t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 3000);
        }
    </script>
</body>
</html>
